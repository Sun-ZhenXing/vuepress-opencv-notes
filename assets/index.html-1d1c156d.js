import{_ as c,M as o,p as l,q as i,R as n,N as a,V as p,t as s,a1 as u}from"./framework-a77b8537.js";const r={},d=n("h1",{id:"opencv-部署快速风格迁移",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#opencv-部署快速风格迁移","aria-hidden":"true"},"#"),s(" OpenCV 部署快速风格迁移")],-1),k={class:"table-of-contents"},m=n("h2",{id:"_1-快速风格迁移简介",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_1-快速风格迁移简介","aria-hidden":"true"},"#"),s(" 1. 快速风格迁移简介")],-1),_={href:"https://arxiv.org/abs/1603.08155",target:"_blank",rel:"noopener noreferrer"},v=n("em",null,"Perceptual Losses for Real-Time Style Transfer and Super-Resolution",-1),h={href:"https://cs.stanford.edu/people/jcjohns/eccv16/",target:"_blank",rel:"noopener noreferrer"},b={href:"https://github.com/jcjohnson/fast-neural-style",target:"_blank",rel:"noopener noreferrer"},f=n("h2",{id:"_2-opencv-部署-torch-模型",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-opencv-部署-torch-模型","aria-hidden":"true"},"#"),s(" 2. OpenCV 部署 Torch 模型")],-1),g=n("p",null,"直接下载模型：",-1),y={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/candy.t7",target:"_blank",rel:"noopener noreferrer"},j={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/la_muse.t7",target:"_blank",rel:"noopener noreferrer"},w={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/mosaic.t7",target:"_blank",rel:"noopener noreferrer"},x={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/feathers.t7",target:"_blank",rel:"noopener noreferrer"},N={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/the_scream.t7",target:"_blank",rel:"noopener noreferrer"},V={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/instance_norm/udnie.t7",target:"_blank",rel:"noopener noreferrer"},C={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/the_wave.t7",target:"_blank",rel:"noopener noreferrer"},B={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/starry_night.t7",target:"_blank",rel:"noopener noreferrer"},T={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/la_muse.t7",target:"_blank",rel:"noopener noreferrer"},E={href:"http://cs.stanford.edu/people/jcjohns/fast-neural-style/models/eccv16/composition_vii.t7",target:"_blank",rel:"noopener noreferrer"},F=u(`<p>然后我们新建 <code>main.py</code>，然后再任意找一张图片 <code>test.jpg</code>，将文件保存如下：</p><ul><li><code>main.py</code></li><li><code>models/</code><ul><li><code>eccv16/</code><ul><li><code>composition_vii.t7</code></li><li><code>la_muse.t7</code></li><li><code>starry_night.t7</code></li><li><code>the_wave.t7</code></li></ul></li><li><code>instance_norm/</code><ul><li><code>candy.t7</code></li><li><code>feathers.t7</code></li><li><code>la_muse.t7</code></li><li><code>mosaic.t7</code></li><li><code>the_scream.t7</code></li><li><code>udnie.t7</code></li></ul></li></ul></li><li><code>test.jpg</code></li></ul><p>然后我们对每一个模型都进行推理测试：</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np


<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>image_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> model_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    net <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>readNetFromTorch<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>setPreferableBackend<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>DNN_BACKEND_OPENCV<span class="token punctuation">)</span>
    image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    blob <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dnn<span class="token punctuation">.</span>blobFromImage<span class="token punctuation">(</span>
        image<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">103.939</span><span class="token punctuation">,</span> <span class="token number">116.779</span><span class="token punctuation">,</span> <span class="token number">123.680</span><span class="token punctuation">)</span><span class="token punctuation">,</span> swapRB<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> crop<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>setInput<span class="token punctuation">(</span>blob<span class="token punctuation">)</span>
    out<span class="token punctuation">:</span> np<span class="token punctuation">.</span>ndarray <span class="token operator">=</span> net<span class="token punctuation">.</span>forward<span class="token punctuation">(</span><span class="token punctuation">)</span>
    out <span class="token operator">=</span> out<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> out<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> out<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    out<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">103.939</span>
    out<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">116.779</span>
    out<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">123.68</span>
    out <span class="token operator">/=</span> <span class="token number">255</span>
    out <span class="token operator">=</span> out<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out


model_list <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">&#39;./models/eccv16/composition_vii.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/eccv16/la_muse.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/eccv16/starry_night.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/eccv16/the_wave.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/instance_norm/candy.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/instance_norm/feathers.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/instance_norm/la_muse.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/instance_norm/mosaic.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/instance_norm/the_scream.t7&#39;</span><span class="token punctuation">,</span>
    <span class="token string">&#39;./models/instance_norm/udnie.t7&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    image_path <span class="token operator">=</span> <span class="token string">&#39;test.jpg&#39;</span>
    <span class="token keyword">for</span> model_path <span class="token keyword">in</span> model_list<span class="token punctuation">:</span>
        out <span class="token operator">=</span> process<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> model_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;out&#39;</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span>
        key <span class="token operator">=</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果需要保存，可以使用下面的代码：</p><div class="language-python" data-ext="py"><pre class="language-python"><code>out <span class="token operator">=</span> <span class="token punctuation">(</span>out <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clip<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span><span class="token string">&#39;out.jpg&#39;</span><span class="token punctuation">,</span> out<span class="token punctuation">)</span>
</code></pre></div>`,6);function I(O,R){const t=o("router-link"),e=o("ExternalLinkIcon");return l(),i("div",null,[d,n("nav",k,[n("ul",null,[n("li",null,[a(t,{to:"#_1-快速风格迁移简介"},{default:p(()=>[s("1. 快速风格迁移简介")]),_:1})]),n("li",null,[a(t,{to:"#_2-opencv-部署-torch-模型"},{default:p(()=>[s("2. OpenCV 部署 Torch 模型")]),_:1})])])]),m,n("p",null,[s("将一张图片的风格迁移到另一张图片上是耗时任务，但是在 2016 年 "),n("a",_,[v,a(e)]),s(" 论文的提出，实现了实时完成这项任务。")]),n("p",null,[s("在 "),n("a",h,[s("此项目的官方网站"),a(e)]),s(" 上，可以查看论文和其效果，推荐阅读。")]),n("p",null,[s("此项目的原始代码托管在 GitHub 上："),n("a",b,[s("jcjohnson/fast-neural-style"),a(e)]),s("，可以下载其预训练权重直接部署。")]),f,g,n("ul",null,[n("li",null,[n("a",y,[s("instance_norm/candy.t7"),a(e)])]),n("li",null,[n("a",j,[s("instance_norm/la_muse.t7"),a(e)])]),n("li",null,[n("a",w,[s("instance_norm/mosaic.t7"),a(e)])]),n("li",null,[n("a",x,[s("instance_norm/feathers.t7"),a(e)])]),n("li",null,[n("a",N,[s("instance_norm/the_scream.t7"),a(e)])]),n("li",null,[n("a",V,[s("instance_norm/udnie.t7"),a(e)])]),n("li",null,[n("a",C,[s("eccv16/the_wave.t7"),a(e)])]),n("li",null,[n("a",B,[s("eccv16/starry_night.t7"),a(e)])]),n("li",null,[n("a",T,[s("eccv16/la_muse.t7"),a(e)])]),n("li",null,[n("a",E,[s("eccv16/composition_vii.t7"),a(e)])])]),F])}const P=c(r,[["render",I],["__file","index.html.vue"]]);export{P as default};
